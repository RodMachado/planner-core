<script type="text/javascript">

RoomApp = new Backbone.Marionette.Application();

RoomApp.RoomManagement = (function(Backbone){
    
    Room = Backbone.Model.extend({
        schema : {
            name : { type : 'Text' }
        },
        urlRoot : '/rooms'
    });

    RoomSetup = Backbone.Model.extend({
        schema : {
            setup_type_id : { type : 'Select', options : <%= SetupType.find(:all).collect {|s| {'val' => s.id, 'label' => s.name} }.to_json.html_safe %> },
            capacity : { type : 'Number' },
            isdefault : { type : 'Checkbox', title : 'Default' }, // This needs to be calculated
        },
        urlRoot : '/room_setups'
    });

    RoomSetupCollection = Backbone.Collection.extend({
        model : RoomSetup
    });
    
    RoomSetupLayout = Backbone.Marionette.Layout.extend({ // TODO
        template: "#room-setup-layout-template",
        
        regions : {
            roomSetupControlRegion: "#room-setup-control-div",
            roomSetupRegion: "#room-setup-region-div",
        },
    });
    
    var tabLists = [];
    var tabControls = [];
    
    function clearDetails() {
        _.invoke(tabLists, 'reset' );
        _.invoke(tabControls, 'close' );
    };
    
    function showSetups(id) {
        roomSetupLayout = new RoomSetupLayout();
        roomSetupLayout.render();
        $('#room-setup-view').html(roomSetupLayout.el);

         tabControls.push( TabUtils.createTabControl({
            template : "#room-setup-control-template",
            modelType : RoomSetup,
            id : id, // need to pass in the name of the id field
            id_name : 'room_id',
            view_refresh_event : "room-setup:refresh",
            modal_create_title : "Create Room Setup",
            region : roomSetupLayout.roomSetupControlRegion,
            callback : function(mdl) {
                $("#rooms").jqGrid('setGridParam', {
                    loadComplete: function(data) {
                        $("#rooms").jqGrid('setSelection', id); // when load is complete the selection is called...
                        // load complete is called every time... only want it once, so remove it after it has been used...
                        $("#rooms").jqGrid('setGridParam', { loadComplete: function() {} });
                    }
                });
                $("#rooms").trigger("reloadGrid");
            }
        }) );
        
        tabLists.push( TabUtils.createTabListContent({
            collectionType : RoomSetupCollection,
            url : "/room_setups/list.json?room_id="+ id,
            template : "#room-setup-template",
            view_refresh_event : "room-setup:refresh",
            region : roomSetupLayout.roomSetupRegion,
            newTitle : "Create Setup",
            editTitle : "Edit Setup",
            updateCallback : function(mdl) {
                $("#rooms").jqGrid('setGridParam', {
                    loadComplete: function(data) {
                        $("#rooms").jqGrid('setSelection', id); // when load is complete the selection is called...
                        // load complete is called every time... only want it once, so remove it after it has been used...
                        $("#rooms").jqGrid('setGridParam', { loadComplete: function() {} });
                    }
                });
                $("#rooms").trigger("reloadGrid");
            }
        }) );
    };
    
    return {
        
        clearDetails : function() {
            clearDetails();
        },
        
        selectRoom : function(id) {
            clearDetails();
            // set the URL for the rooms and get it to refresh
            $("#rooms").roomTable("getRoomForVenue", id);
            tabControls.push( TabUtils.createTabControl({ // TODO - the new room needs to have the venue id in the URL
                template : "#room-control-template",
                modelType : Room,
                id : id, // need to pass in the name of the id field
                id_name : 'venue_id',
                modal_create_title : "Create Room",
                place :'#room-control',
                callback : function(mdl) {
                    // Refresh the grid - goto the page with the new item and make that the current selection
                    jQuery("#rooms").jqGrid('setGridParam', {
                         postData : {
                                 page_to : mdl.get('name'), // make sure that the current page contains the selected element
                                 filters : {},
                                 current_selection : mdl.id // to pass back for the selection
                             },
                    });
                    jQuery("#rooms").trigger("reloadGrid");
                },
            }));
        },
        
        showSetups : function(id) {
            showSetups(id);
        }
    }

})(Backbone);

</script>
