<script type="text/javascript">

ParticipantApp = new Backbone.Marionette.Application();

ParticipantApp.PeopleManagement = (function(Backbone){
    var eventAggregator = AppUtils.eventAggregator;

    //
    //
    //
    Address = Backbone.Model.extend({
        schema : {
            line1 : { type : 'Text', title : '<%= t "line1" %>' },
            line2 : { type : 'Text', title : '<%= t "line2" %>' },
            line3 : { type : 'Text', title : '<%= t "line3" %>' },
            city : { type : 'Text', title : '<%= t "city" %>' },
            state : { type : 'Text', title : '<%= t "state" %>' },
            postcode : { type : 'Text', title : '<%= t "post-code" %>' },
            country : { type : 'Text', title : '<%= t "country" %>' },
            isdefault : { type : 'Checkbox', title : '<%= t "is-default" %>'},
        },
        urlRoot : '/postal_addresses'
    });
    
    AddressCollection = Backbone.Collection.extend({
        model : Address
    });
    
    EmailAddress = Backbone.Model.extend({
        schema : {
            email : { type : 'Text', title : '<%= t "email" %>'},
            isdefault : { type : 'Checkbox', title : '<%= t "is-default" %>'}
        },
        urlRoot : '/email_addresses'
    });
    
    EmailCollection = Backbone.Collection.extend({
        model : EmailAddress
    });
    
    PhoneNumber = Backbone.Model.extend({
        schema : {
            number : { type : 'Text', title : '<%= t "phone-number" %>'},
            phone_type_id : { type : 'Select', title : '<%= t "phone type" %>', options : <%= PhoneTypes.find(:all).collect {|s| {'val' => s.id, 'label' => s.name} }.to_json.html_safe %> },
        },
        urlRoot : '/phone_numbers'
    });
    
    PhoneCollection = Backbone.Collection.extend({
        model : PhoneNumber
    });

    //
    //
    //
    RegistrationDetail = Backbone.Model.extend({
        schema : {
            registration_number : { type : 'Number', title : '<%= t "reg-number" %>' },
            registration_type : { type : 'Text', title : '<%= t "reg-type" %>' },
            registered : { type : 'Checkbox', title : '<%= t "registered" %>' },
        },
        urlRoot: '/registrationDetails'
    });
    
    //
    Pseudonym = Backbone.Model.extend({
        schema : {
            first_name  : { type : 'Text', title : '<%= t "first-name" %>'},
            last_name  : { type : 'Text', title : '<%= t "last-name" %>'},
            suffix  : { type : 'Text', title : '<%= t "suffix" %>'},
        }
    });
    
    InviteDetails = Backbone.DeepModel.extend({
        schema : {
            first_name : { type : 'Text', title : '<%= t "first-name" %>', editorAttrs : { placeholder : '<%= t "first-name" %>' } },
            last_name : { type : 'Text', title : '<%= t "last-name" %>', editorAttrs : { placeholder : '<%= t "last-name" %>' } },
            suffix : { type : 'Text', title : '<%= t "suffix" %>', editorAttrs : { placeholder : '<%= t "suffix" %>' } },
            'pseudonym.first_name' : { type : 'Text', title : '<%= t "pub-first-name" %>', editorAttrs : { placeholder : '<%= t "pub-first-name" %>' } },
            'pseudonym.last_name' : { type : 'Text', title : '<%= t "pub-last-name" %>', editorAttrs : { placeholder : '<%= t "pub-last-name" %>' } },
            'pseudonym.suffix' : { type : 'Text', title : '<%= t "pub-suffix" %>', editorAttrs : { placeholder : '<%= t "suffix" %>' } },
            'company' : { type : 'Text', title : '<%= t "company" %>', editorAttrs : { placeholder : '<%= t "company" %>' } },
            'job_title' : { type : 'Text', title : '<%= t "job-title" %>', editorAttrs : { placeholder : '<%= t "job-title" %>' } },
            'comments' : { type : 'TextArea', title : '<%= t "comments" %>' },
            invitestatus_id : { type : 'Select', title : '<%= t "invitation-status" %>', options : <%= InviteStatus.find(:all).collect {|s| {'val' => s.id, 'label' => s.name} }.to_json.html_safe %> },
            acceptance_status_id : { type : 'Select', title : '<%= t "acceptance-status" %>', options : <%= AcceptanceStatus.find(:all).collect {|s| {'val' => s.id, 'label' => s.name} }.to_json.html_safe %> },
            invitation_category_id : { type : 'Select', title : '<%= t "invitation-category" %>', options : <%= [[' ',' ']].concat(InvitationCategory.find(:all).collect {|s| {'val' => s.id, 'label' => s.name} }).to_json.html_safe %> },

        },
        urlRoot : '/participants'
    });

    //
    BioDetails = Backbone.Model.extend({
        schema : {
            survey_bio : { type : 'TextArea', title : '<%= t "bio-from-survey" %>', editorAttrs: { readonly : true, rows : 6, cols : 60 } },
            bio : { type : 'Html', title : '<%= t "bio" %>', editorAttrs: { rows : 6, cols : 60 } },
            facebook : { type : 'Text', title : '<%= t "participant-facebook-url" %>' },
            othersocialmedia : { type : 'Text', title : '<%= t "other-social-media" %>' },
            photourl : { type : 'Text', title : '<%= t "participant-photo" %>' },
            twitterinfo : { type : 'Text', title : '<%= t "participant-twitter-handle" %>' },
            website : { type : 'Text', title : '<%= t "participant-url" %>' }
        },
        urlRoot : '/edited_bios'
    });
    
    BioPicture = Backbone.Model.extend({
        schema : {
            bio_picture : { type : 'CLImage', title : 'Bio Pic',
                cl_image_upload_tag : '<%= cl_image_upload_tag(:bio_picture) %>'
            }
        },
        urlRoot : '/bio_images'
    });
    
    //
    ProgramItem = Backbone.Model.extend({
    });
    ProgramItemCollection = Backbone.Collection.extend({
        model : ProgramItem
    });
    
    //
    TagContext = Backbone.Model.extend({
    });
    TagContextCollection = Backbone.Collection.extend({
        model : TagContext
    });
    
    //
    TagFilter = Backbone.Model.extend({
        // Context name & Tag name
        // no ids cause no sync with backend
    });
    TagFilterCollection = Backbone.Collection.extend({
        model : TagFilter
    });
    
    //
    AvailabilityDateModel = Backbone.RelationalModel.extend({
        schema : {
            start_time : { type : 'Datetime', title : '<%= t "item-start-time" %>',
                    tz_offset : <%= Time.zone.parse(SiteConfig.first.start_date.to_s).utc_offset/(60*60) %>,
                    picker : {
                        useSeconds : false,
                        minuteStepping : 15,
                        orientation : 'left',
                        format : "DD MMM YYYY, HH:mm",
                        defaultDate : "<%= Time.zone.parse(SiteConfig.first.start_date.to_s).strftime('%m/%d/%Y') %>",
                        startDate : "<%= Time.zone.parse(SiteConfig.first.start_date.to_s).strftime('%m/%d/%Y') %>",
                        endDate : "<%= (Time.zone.parse(SiteConfig.first.start_date.to_s) + ((SiteConfig.first.number_of_days).to_i).days).strftime('%m/%d/%Y') %>"
                } },
            end_time : { type : 'Datetime', title : '<%= t "item-start-time" %>',
                    tz_offset : <%= Time.zone.parse(SiteConfig.first.start_date.to_s).utc_offset/(60*60) %>,
                    picker : {
                        useSeconds : false,
                        minuteStepping : 15,
                        orientation : 'left',
                        format : "DD MMM YYYY, HH:mm",
                        defaultDate : "<%= Time.zone.parse(SiteConfig.first.start_date.to_s).strftime('%m/%d/%Y') %>",
                        startDate : "<%= Time.zone.parse(SiteConfig.first.start_date.to_s).strftime('%m/%d/%Y') %>",
                        endDate : "<%= (Time.zone.parse(SiteConfig.first.start_date.to_s) + ((SiteConfig.first.number_of_days).to_i).days).strftime('%m/%d/%Y') %>"
                } }
        },
        urlRoot : '/available_dates'
    });
    ExcludedItemModel = Backbone.RelationalModel.extend({});
    ExcludedItemCollection = Backbone.Collection.extend({
        model : ExcludedItemModel
    });
    ExcludedTimesModel = Backbone.RelationalModel.extend({
    });
    ExcludedTimesCollection = Backbone.Collection.extend({
        model : ExcludedTimesModel
    });
    Exclusions = Backbone.RelationalModel.extend({
        relations: [{
            type: Backbone.HasMany,
            key: 'items',
            relatedModel: 'ExcludedItemModel',
            collectionType : 'ExcludedItemCollection',
        }, {
            type: Backbone.HasMany,
            key: 'times',
            relatedModel: 'ExcludedTimesModel',
            collectionType : 'ExcludedTimesCollection',
        }, {
            type: Backbone.HasOne,
            key: 'dates',
            relatedModel: 'AvailabilityDateModel',
        }
        ]
    });

    /******************************************************
     * 
     */
    AddressLayout = Backbone.Marionette.Layout.extend({
        template: "#address-layout-template",
        
        regions : {
            postalControlRegion: "#postal-control-div",
            postalRegion: "#postal-region-div",
        },
    });

    PhoneLayout = Backbone.Marionette.Layout.extend({
        template: "#phone-layout-template",
        
        regions : {
            phoneControlRegion: "#phone-control-div",
            phoneRegion: "#phone-region-div",
        },
    });
    EmailLayout = Backbone.Marionette.Layout.extend({
        template: "#email-layout-template",
        
        regions : {
            emailControlRegion: "#email-control-div",
            emailRegion: "#email-region-div",
        },
    });
    
    ExclusionsLayout = Backbone.Marionette.Layout.extend({
        template: "#exclusions-layout-template",
        
        regions : {
            datesRegion: "#dates-exclusions-div",
            itemsRegion: "#items-exclusions-div",
            timesRegion: "#times-exclusions-div",
        },
    });

    var tabLists = [];
    var tabContent = [];
    var filters = null;

    function clearRegDetails() {
        $('#selected-participant').text("");
        
        // _.invoke(tabLists, 'reset' );
        // _.invoke(tabContent, 'clear' );
        
        eventAggregator.off("refreshTagList", syncModel);
    };

    function syncModel() {
        this.fetch({async : false});
    };
    
    function getPersonName(data) {
        var res = "";

        if (typeof data['person[pseudonym_attributes][first_name]'] != 'undefined') {
            if (data['person[pseudonym_attributes][first_name]']) {
                res += data['person[pseudonym_attributes][first_name]'];
            };
        };
        if (typeof data['person[pseudonym_attributes][last_name]'] != 'undefined') {
            if (data['person[pseudonym_attributes][last_name]']) {
                if (res.length > 0) {
                    res += ' ';
                };
                res += data['person[pseudonym_attributes][last_name]'];
            };
        };
        if (typeof data['person[pseudonym_attributes][suffix]'] != 'undefined') {
            if (data['person[pseudonym_attributes][suffix]']) {
                if (res.length > 0) {
                    res += ' ';
                };
                res += data['person[pseudonym_attributes][suffix]'];
            };
        };
        
        var name = (data['person[first_name]'] + ' ' + data['person[last_name]'] + ' ' + data['person[suffix]']).trim();
                    
        if (res.length > 0) {
            res += " (" +  name + ")";
        } else {
            res = name;
        };

        return res;
    };

    function showRegDetails(id) {
        var data = jQuery("#participants").jqGrid('getRowData', id);
        
        $('#selected-participant').text(getPersonName(data));
        
        tabContent.push( TabUtils.createTabContent({
            modelType : RegistrationDetail,
            url : "/participants/" + id + "/registrationDetails.json",
            template : '#registration-view-template',
            place :'#registration-view',
            id : id,
            id_name : 'person_id',
            newTitle : '<%= t "create-registration" %>',
            editTitle : '<%= t "edit-registration" %>',
        }) );

        var invite_details = TabUtils.createTabContent({
            modelType : InviteDetails,
            url : "/participants/" + id + ".json",
            template : '#invite-view-template',
            place : '#invite-view',
            id : id,
            id_name : 'person_id',
            newTitle : '<%= t "create-invite" %>',
            editTitle : '<%= t "edit-invite" %>',
            updateCallback : function(mdl) {
                $("#participants").jqGrid('setGridParam', {
                    loadComplete: function(data) {
                        $("#participants").jqGrid('setSelection', id); // when load is complete the selection is called...
                        $(this).jqGrid('setGridParam', { loadComplete: function() {} });
                    }
                });
                $("#participants").trigger("reloadGrid");
            },
            events : {
                'click .model-generate-invite-key-button' : function() {
                    mdl = this.model;
                    $.ajax({
                        url : "/participants/generateInviteKey/" + id + ".json",
                        success : function() {
                            mdl.fetch();
                        }
                    })
                }
            }
        });
        
        tabContent.push( invite_details );
        
        tabContent.push( 
            TabUtils.createTabContent({
            modelType : BioDetails,
            url : "/participants/" + id + "/edited_bios.json",
            template : '#bio-view-template',
            place : '#bio-view',
            id : id,
            id_name : 'person_id',
            newTitle : '<%= t "create-bio" %>',
            editTitle : '<%= t "edit-bio" %>',
        }) );
        
        tabContent.push( 
            TabUtils.createTabContent({
            modelType : BioPicture,
            url : "/participants/" + id + "/bio_images.json",
            template : '#bio-image-template',
            place : '#bio-image',
            id : id,
            id_name : 'person_id',
            newTitle : '<%= t "create-bio-image" %>',
            editTitle : '<%= t "edit-bio-image" %>',
        }) );
        
        tabLists.push( TabUtils.createTabListContent({
            collectionType : ProgramItemCollection,
            url : "/participants/"+ id + "/programme_items.json",
            template : "#program-item-view-template",
            view_refresh_event : "address:refresh",
            place : '#items-view',
        }) );

        
        // ------
        addressLayout = new AddressLayout();
        addressLayout.render();
        $('#contacts-view').html(addressLayout.el);
        
        phoneLayout = new PhoneLayout();
        phoneLayout.render();
        $('#phone-view').html(phoneLayout.el);

        emailLayout = new EmailLayout();
        emailLayout.render();
        $('#email-view').html(emailLayout.el);


        TabUtils.createTabControl({
            template : "#address-control-template",
            modelType : Address,
            id : id,
            id_name : 'person_id',
            view_refresh_event : "address:refresh",
            modal_create_title : '<%= t "create-address-details" %>',
            region : addressLayout.postalControlRegion
        });
        tabLists.push( TabUtils.createTabListContent({
            collectionType : AddressCollection,
            url : "/participants/"+ id + "/postalAddresses.json",
            template : "#address-view-template",
            view_refresh_event : "address:refresh",
            region : addressLayout.postalRegion,
            newTitle : '<%= t "create-address" %>',
            editTitle : '<%= t "edit-address" %>',
        }) );
        
        TabUtils.createTabControl({
            template : "#phone-control-template",
            modelType : PhoneNumber,
            id : id,
            id_name : 'person_id',
            view_refresh_event : "address:refresh",
            modal_create_title : '<%= t "create-phone-number" %>',
            region : phoneLayout.phoneControlRegion,
        });
        tabLists.push( TabUtils.createTabListContent({
            collectionType : PhoneCollection,
            url : "/participants/"+ id + "/phoneNumbers.json",
            template : "#phone-view-template",
            view_refresh_event : "address:refresh",
            region : phoneLayout.phoneRegion,
            newTitle : '<%= t "create-phone-number" %>',
            editTitle : '<%= t "edit-phone-number" %>',
        }) );

        TabUtils.createTabControl({
            template : "#email-control-template", 
            modelType : EmailAddress,
            id : id,
            id_name : 'person_id',
            view_refresh_event : "address:refresh",
            modal_create_title : '<%= t "create-email" %>',    
            region : emailLayout.emailControlRegion
        });
        tabLists.push( TabUtils.createTabListContent({
            collectionType : EmailCollection,
            url : "/participants/"+ id + "/emailAddresses.json",
            template : "#email-view-template",
            view_refresh_event : "address:refresh",
            region : emailLayout.emailRegion,
            newTitle : '<%= t "create-email" %>',
            editTitle : '<%= t "edit-email" %>',
        }) );
        
        // /tags/2108/add?class=Person&context=PrimaryArea 
        tabLists.push( TabUtils.createTagListContent({
            collectionType : TagContextCollection,
            url : "/tags/"+ id + ".json?class=Person",
            tagUrl : "/tags/"+ id + "/add?class=Person",
            template : "#tag-context-layout-template",
            view_refresh_event : "address:refresh",
            place : '#tags-view',
            newTitle : '<%= t "create-tag" %>',
        }) );

        //
        // get the exclusions and show them within the layout
        //
        exclusionLayout = new ExclusionsLayout();
        exclusionLayout.render();
        $('#availability-view').html(exclusionLayout.el);
        
        exclusions = new Exclusions();
        exclusions.fetch({
            url : "/participants/" + id + "/availabilities.json",
            success : function(obj) {
                tabLists.push( TabUtils.createTabListContent({
                    collection : obj.get('items'),
                    template : "#item-exclusion-view-template",
                    region : exclusionLayout.itemsRegion 
                }) );
                tabLists.push( TabUtils.createTabListContent({
                    collection : obj.get('times'),
                    template : "#time-exclusion-view-template",
                    region : exclusionLayout.timesRegion 
                }) );

                var availability = obj.get('dates');
                if (availability) {
                    availability.url = "/participants/" + id + '/available_dates/' + availability.id;
                }
                tabContent.push( TabUtils.createTabContent({
                        url : "/participants/" + id + '/available_dates.json',
                        id : id,
                        id_name : 'person_id',
                        modelType : AvailabilityDateModel,
                        model : availability,
                        template : '#date-exclusion-view-template',
                        region : exclusionLayout.datesRegion,
                        newTitle : '<%= t "create-availability" %>',
                        editTitle : '<%= t "edit-availability" %>',
                        view_refresh_event : "address:refresh",
                }) );
            }
        });

        eventAggregator.on("refreshTagList", syncModel, invite_details);
        
        return invite_details;
    };
    
    var filterCol = null;

    //
    //
    //    
    return {
        
        InviteDetails : InviteDetails,
        
        showDetails : function(id) {
            clearRegDetails();
            return showRegDetails(id);
        },
        clearDetails : function() {
            clearRegDetails();
        },
        addFilter : function(context, name) {
            if (!filters) {
                filters = new TagFilterCollection();
            }
            
            if (!filterCol) {
                filterCol = TabUtils.createTabListContent({
                    collection : filters,
                    template : "#participant-filters-template",
                    place : "#participant-filters",
                    collection_attributes : { "class" : "clearfix" },
                    tagremove : function(context, name) {
                        // force a refresh of the table etc
                        ParticipantApp.PeopleManagement.refreshTable();
                    },
                    view_attributes : { "style" : "display : inline" },
                });
                
            }
            
            filters.add(
                new TagFilter({
                    context : context,
                    name : name
                })
            );
        },

        getTagQuery : function() {
            var tagQuery = "";
            
            // go through the filters are create the query for the tags ...
            if (filters) {
                // convert the filters into an associative array and then build the query...
                var filterArray = {}
                _.each(filters, function(el, index, list) {
                    var ctx = filters.at(index).get('context');
                    if (!filterArray[ctx]) {
                        filterArray[ctx] = filters.at(index).get('name');
                    } else {
                        filterArray[ctx] += ',' + filters.at(index).get('name');                    
                    };
                });
                var str = "";
                var index = 0;
                _.each(filterArray, function(val, key, list) {
                    if (index > 0) {
                        str += "&";
                    };
                    str += "context[" + index + "]=" + key + "&tags[" + index + "]=" + escape(val);
                    index += 1;
                });
                tagQuery = str;
            }
            
            return tagQuery;
        },
        
        refreshTable : function() {
            // get the tags etc from the view and create the query
            var tagQuery = ParticipantApp.PeopleManagement.getTagQuery();
            jQuery("#participants").participantTable('tagQuery',{
                tagQuery : tagQuery
            });
        }
    };
})(Backbone);

/*
 * 
 */
jQuery(document).ready(function() {
    ParticipantApp.start();
    
    TabUtils.createTagCloudContent({
        collectionType : TagContextCollection,
        url : "/tags.json?class=Person",
        template : "#tag-cloud-context-layout-template",
        place : '#participant-tag-cloud',
        collection_attributes : { "class" : "accordion", "id" : "participant-tag-cloud-parent" },
        view_attributes : { "class" : "accordion-group" },
        tagselect : function(context, name) {
            ParticipantApp.PeopleManagement.addFilter(context, name);
            ParticipantApp.PeopleManagement.refreshTable();
        },
    });
});
</script>

