<%# 
%>    
<script type="text/javascript">
//<![CDATA[
jQuery(document).ready(function() {
    //Patch for template variables in _underscore top stop class with Rails variables in the file
    _.templateSettings = {
        interpolate : /\{\{\=(.+?)\}\}/g,
        evaluate : /\{\{(.+?)\}\}/g
    };


    //
    // Model for Query
    //
    SurveyName = Backbone.Model.extend({
        defaults : {
            name : 'name',
        },
    });

    Question = Backbone.Model.extend({
        defaults : {
            question : 'name',
        },
    }); 



    ResultRow = Backbone.RelationalModel.extend({});
    
    // ResultMetaDataRow = Backbone.RelationalModel.extend({});

    ResultRowCollection = Backbone.Collection.extend({
        model : ResultRow
    });
    
    ResultSet = Backbone.RelationalModel.extend({
        url : '/survey_reports/runReport',
        
        relations : [{
            type : Backbone.HasMany,
            key : 'rowdata',
            relatedModel : 'ResultRow',
            collectionType : 'ResultRowCollection',
        }],

    });
    
    
    // var tr = new ResultSet(
    // { "id" : 1, "totalpages": 1, "currpage": 1, "totalrecords": 1, 
    // rowdata: [{"survey_respondent_id":null,"first_name":"Bradford","lock_version":0,"survey_question_id":"1",
    // "survey_respondent_detail_id":"13","created_at":"2012-12-12T00:59:38-05:00","updated_at":"2012-12-12T00:59:38-05:00",
    // "suffix":"","response":"San Mateo, CA, USA","email":"bradlyau@aol.com","id":81,"survey_id":"1",
    // "response6":null,"response5":null,"response4":null,"response3":null,"response2":null,"response1":null,"last_name":"Lyau",
    // "isbio":null}]}
    // );
    // alert(JSON.stringify(tr.toJSON()));


    SurveyNameCollection = Backbone.Collection.extend({
        model : SurveyName,
        url : '/survey_reports/surveyNames'
    });

    QuestionsCollection = Backbone.Collection.extend({
        model : Question,
        url : '/survey_reports/questions'
    });



    //
    //
    //
    SurveyQuery = Backbone.RelationalModel.extend({
        defaults : {
            name : '', // The name of the query
            operation : 'ALL' // can be ALL or ANY
        },

        // Collection predicates
        relations : [{
            type : Backbone.HasMany,
            key : 'queryPredicates',
            relatedModel : 'QueryPredicate',
            //includeInJSON: Backbone.Model.prototype.idAttribute,
            collectionType : 'PredicateCollection', // ?????
            reverseRelation : {
                key : 'surveyQuery',
            }
        }],

        // urlRoot: '/survey_query', // URL for the save or update of a survey query i.e URL for the controller using REST based semantics
    });


    //
    // The predicate for the query
    //
    QueryPredicate = Backbone.RelationalModel.extend({
        defaults : {
            question_id : '', // The id of the question from the database
            operation : '=', // The operation: =, <>, contains
            value : '' // The value that we are searching for
        }
    });

    PredicateCollection = Backbone.Collection.extend();
    // TODO - add URL method to create a URL for the whole collection

    
    //
    //
    //
    ResultsView = Backbone.View.extend({
        el : '#query-results',

        tagName : 'div',

        template : _.template($('#query-results-template').html()),

        render : function() {
            // TODO - determine the col model from the array : this.resultsCollection
            // this.query
            // q1, q2 etc.
            // alert(JSON.stringify(this.resultsCollection.get('userdata').toJSON()));
            
            //talpages":1,"currpage":1,"totalrecords":2,"userdata":
            var colModel = [ 
                    {name:'First Name', jsonmap: "first_name", sortable:true, width: 30}, 
                    {name:'Last Name', jsonmap: "last_name", sortable:true, width: 30}, 
                ];
                
            for (var key in this.resultsCollection.get('userdata')) {
                // alert(key + ' => ' + this.resultsCollection.get('userdata')[key]['question']);
                colModel.push( {name: this.resultsCollection.get('userdata')[key]['question'], jsonmap: key, cellattr: function (rowId, tv, rawObject, cm, rdata) { return 'style="white-space: pre-wrap;"' } } );
            };

            this.$el.html(this.template());
            
            this.grid = $('.result-table').jqGrid({
                colModel : colModel,
                // [ 
                    // {name:'First Name', jsonmap: "first_name", sortable:true}, 
                    // {name:'Last Name', jsonmap: "last_name", sortable:true}, 
                // ],
                datatype: 'jsonstring',
                datastr: this.resultsCollection.toJSON(),
                jsonReader :{
                    repeatitems : false,
                    page: "currpage",
                    records: "totalrecords",
                    root : "rowdata",
                    total: "totalpages",
                    id : "id",
                    // userdata : "userdata"
                },
                // rowNum: 2,
                viewrecords: true,
                height: "auto",
                autowidth: true,
                ignoreCase: true,
                gridview: true,
                // rowList: [10, 20, 500],
                // gridview: true,
                // autowidth: true,
                // viewrecords: true,
                pager : '#result-pager',
                caption: 'Results'
            });
            // this.grid.jqGrid('navGrid','#result-pager',{edit:false,add:false,del:false,search:false});
            
            return this;
        },

        initialize : function() {
        },
    });





    //
    PredicateView = Backbone.View.extend({
        tagName : 'li',

        template : _.template($('#predicate-template').html()),

        events : {
            'click .questionID' : 'selectQuestion',
            'click .operator' : 'selectOperator',
            'blur .query-text' : 'selectText',
            'click .remove-button' : 'removeQuestion',
        },

        selectQuestion : function(ev) {
            this.model.set("question_id", $(ev.currentTarget).val());
        },

        selectOperator : function(ev) {
            this.model.set("operation", $(ev.currentTarget).val());
        },

        selectText : function(ev) {
            this.model.set("value", $(ev.currentTarget).val());
        },

        removeQuestion : function(ev) {
            this.$el.html("");
            this.model.destroy();
            // remove from the model - now we need to update the view
        },

        initialize : function() {
        },

        render : function() {
            this.$el.html(this.template(_.extend({
                col : questionsCollection
            }, this.model.toJSON())));
            return this;
        },
    }); 

  
  
  
    // ResultRow = Backbone.Model.extend({});
    // RowData = Backbone.Collection.extend({
        // model : ResultRow
    // });
    // ResultSet = Backbone.Model.extend({
        // url : '/survey_reports/runReport',
//         
        // defaults : { rowdata : [] },
//         
        // initialize : function() {
            // this.rowdata = new RowData(this.get('rowdata'));
            // // alert('HH');
            // // //this.rowdata = this.get('rowdata');
            // // _.bindAll(this, 'fetch_success');
            // // this.bind('change', this.fetch_success);
        // },
//         
        // parse : function(response, options) {
            // alert(response);
//             
            // return response;
        // }
//         
        // // fetch_success : function() {
            // // this.rowdata = new RowData(this.get('rowdata'))
        // // }
    // });

    QueryView = Backbone.View.extend({
        el : '#queryapp',

        selected : 0,
        // operation : 'ANY',

        template : _.template($('#query-template').html()),

        render : function() {
            this.$el.html(this.template({
                operation : this.model.get('operation')
            }));
            // {col : questionsCollection, selected : this.selected}
            return this;
        },

        initialize : function() {
            this.model.on('remove:queryPredicates', this.elementRemoved, this)
        },

        elementRemoved : function(removed, related) {
            this.$('#query-list li:empty').remove();
        },

        events : {
            "click .add-button" : "addOne",
            "click .run-button" : "run",
            'click #match' : 'selectMatch',
        },
        
        selectMatch : function(ev) {
            this.model.set('operation', $(ev.currentTarget).val());
        },

        run : function() {
            var q = questionsCollection;

            resultSet = new ResultSet();
            resultSet.fetch({
                type : 'POST',
                data : 'query=' + JSON.stringify(this.model.toJSON()),
                error : function(model, response) {
                  alert("ERROR: unable to get the result from the server");  
                },
                success : function(model) {
                    if (this.resultView) {
                        this.resultView.resultsCollection = model;
                        this.resultView.queryColl = q;
                    } else {
                        this.resultView = new ResultsView({});
                        this.resultView.resultsCollection = model;
                        this.resultView.queryColl = q;
                    }
                    this.resultView.render();
                }
            })
        },

        addOne : function() {
            // create a new predicate add it to the collection and put it in the view
            var qp = new QueryPredicate();
            //alert(JSON.stringify(qp.toJSON()));
            qp.set({
                'surveyQuery' : this.model
            });

            var view = new PredicateView({
                model : qp,
                col : questionsCollection
            });
            $('#query-list').append(view.render().el);
        },
    }); 


    NewQueryView = Backbone.View.extend({
        tagName : 'div',
        className : 'new-query-dialog',
        id : 'new-query-dialog',

        selected : 0,

        template : _.template($('#new-query-template').html()),

        render : function() {
            var obj = this.$el.html(this.template({
                col : surveyNameCollection,
                selected : this.selected
            }));
            this.dialog = obj.dialog({
                title : 'Create Query',
                modal : true,
                // width: 600,
            });
        },

        events : {
            'click #surveyID' : 'setSelected',
            'click #save-button' : 'save',
            'click #close-button' : 'close',
        },

        createQuery : function() {
            alert("selected = " + this.selected);
        },

        setSelected : function(ev) {
            // get the questions for the given survey
            this.selected = $(ev.currentTarget).val();
        },

        save : function(ev) {
            // alert(this.selected);
            this.dialog.dialog('close');

            // instantiate the list of questions
            questionsCollection = new QuestionsCollection();
            questionsCollection.url = "/survey_reports/questions?survey=" + this.selected;
            questionsCollection.fetch({
                success : function(model) {
                    // and pass that to the next view
                    CurrentQuery = new SurveyQuery;
                    if (this.qv) {
                        //this.qv.remove;
                        this.qv.questionsCollection = model;
                        this.qv.model = CurrentQuery;
                    } else {
                        this.qv = new QueryView({
                            questionsCollection : model,
                            model : CurrentQuery
                        });
                    }

                    this.qv.render();

                    //return this.qv;
                }
            });
        },

        close : function(ev) {
            this.dialog.dialog('close');
        },

        initialize : function() {
            this.render();
        },
    });

  


    AppView = Backbone.View.extend({
        el : '#query-ctl',

        template : _.template($('#query-ctl-template').html()),

        render : function() {
            this.$el.html(this.template);
            return this;
        },

        events : {
            "click .new-query" : "newQuery"
        },

        newQuery : function() {
            surveyNameCollection = new SurveyNameCollection();
            surveyNameCollection.fetch({
                success : function(model) {
                    if (this.nq) {
                        this.nq.surveyNameCollection = model;
                        this.nq.render();
                    } else {
                        this.nq = new NewQueryView({
                            surveyNameCollection : model
                        });
                    }
                }
            });
        },

        initialize : function() {
            this.render();
        },
    });

    //
    // Routes
    //
    AppRouter = Backbone.Router.extend({
        routes : {
        },
    });

  
    var CurrentQuery = new SurveyQuery;

    //
    //
    //
    var app = new AppView();

    var app_router = new AppRouter();

    Backbone.history.start();
}); 
//]]>
</script>
