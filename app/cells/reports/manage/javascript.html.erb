<script type="text/javascript">

ReportApp = new Backbone.Marionette.Application();

ReportApp.ReportManagement = (function(Backbone){
    
    ResultSet = Backbone.RelationalModel.extend({
        relations : [{
            type : Backbone.HasMany,
            key : 'rowdata',
            relatedModel : 'ResultRow',
            collectionType : 'ResultRowCollection',
        }],
    });

    var PanelsWithPanelistsForm = Backbone.Form.extend({
        schema : {
            modified_since  : { type : 'Date', title : '<%= t "Modified Since" %>' },
            sort_by : { type : 'Select', title : '<%= t "Sort By" %>', options : [{ val: 'time', label: 'Date/Time' }, { val: 'room', label: 'Room' }, { val: 'title', label: 'Title' }] },
            scheduled       : { type : 'Checkbox', title : '<%= t "Only Scheduled Items" %>'}, // Include scheduled panels only
            // description     : { type : 'Checkbox'}, // Include item descriptions
            format_id       : { type : 'Select', title : '<%= t "Format" %>', title : '<%= t "format" %>', options : <%= [{'val' => -1, 'label' => 'All'}].concat(Format.find(:all).collect {|s| {'val' => s.id, 'label' => s.name} }).to_json.html_safe %> },
            fewer_than      : { type : 'Number', title : '<%= t "With Fewer Than (participants)" %>'},
            more_than       : { type : 'Number', title : '<%= t "With More Than (participants)" %>'}
        },
        
        data : {
            sort_by : 'time',
            modified_since : new Date('January 1, 2000')
        }
        
    });
    
    var PanelistsWithPanelsForm = Backbone.Form.extend({
        schema : {
            scheduled   : { type : 'Checkbox', title : '<%= t "Only Scheduled Items" %>'}, // Include scheduled panelists only
            reserved    : { type : 'Checkbox', title : '<%= t "Incuded Reserved Participants" %>'},
            forprint    : { type : 'Checkbox', title : '<%= t "Only Items for Print" %>'}
        },
        
        data : {
        }
    });
    
    var TagsByContextForm = Backbone.Form.extend({
        schema : {
            context : { type : 'Select', title : '<%= t "For Tag Context" %>', 
                options : <%= TagContext.all(:order => 'name').collect {|s| {'val' => s.name, 'label' => s.name} }.to_json.html_safe %> },
        },
        
        data : {
        }
    });
    
    var PeopleByTagForm = Backbone.Form.extend({
        schema : {
        },
        
        data : {
        }
    });
    
    var PeopleByTagColModel = [
                    {name: 'context', label : '<%= t "Tag Context" %>', jsonmap: "context", width: 100},
                    {name: 'tag', label : '<%= t "Tag(s)" %>', jsonmap: "tag", width: 100},
                    {name: 'people', label : '<%= t "People" %>', jsonmap: "people", formatter: AppUtils.arrayToStringSingleLine}
    ];
    
    var TagsByContextColModel = [
                    {name: 'Name', label : '<%= t "Person" %>', jsonmap: "name", width: 100},
                    {name: 'Tags', label : '<%= t "Tags" %>', jsonmap: "tags", width: 300, formatter: AppUtils.arrayToStringSingleLine}
    ];
    
    var PanelistsWithPanelsColModel = [
                    {name: 'Name', label : '<%= t "Person" %>', jsonmap: "name", width: 130},
                    {name: 'Status', label : '<%= t "Acceptance Status" %>', jsonmap: "acceptance_status", width: 60},
                    {name:'Items', label : '<%= t "Items" %>', jsonmap: "items", width: 500, formatter: AppUtils.arrayToString},
    ];
    
    var PanelsWithPanelistsColModel = [ 
                    {name: 'Ref', label : '<%= t "Pub Ref" %>', jsonmap: 'pub_reference_number', width: 100},
                    {name:'Title', label : '<%= t "Item Title" %>', jsonmap: "title", width: 500},
                    {name:'Venue', label : '<%= t "Venue" %>', jsonmap: "venue_name"},
                    {name:'Room', label : '<%= t "Room" %>', jsonmap: "room_name"},
                    {name: 'Format', label : '<%= t "Item Format" %>', jsonmap: 'format'},
                    {name: 'Area(s)', label : '<%= t "Area(s)" %>', jsonmap: 'context', formatter: AppUtils.arrayToString},
                    {name: 'Start Time', label : '<%= t "Start Time" %>', jsonmap: 'start_time'},
                    {name: 'End Time', label : '<%= t "End Time" %>', jsonmap: 'end_time'},
                    {name: 'Min People', label : '<%= t "Min Participants" %>', jsonmap: 'minimum_people'},
                    {name: 'Max People', label : '<%= t "Max Participants" %>', jsonmap: 'maximum_people'},
                    {name: 'Equipment', label : '<%= t "Equipment" %>', jsonmap: 'equipment',width: 300, formatter: AppUtils.arrayToString},
                    {name: 'Moderator(s)', label : '<%= t "Moderator(s)" %>', jsonmap: 'moderators',width: 300, formatter: AppUtils.arrayToString },
                    {name: 'Participants', label : '<%= t "Participants" %>', jsonmap: 'participants',width: 300, formatter: AppUtils.arrayToString }, 
                    {name: 'Reserve', label : '<%= t "Reserved" %>', jsonmap: 'reserve',width: 300,formatter: AppUtils.arrayToString},
                    {name: 'Invisible', label : '<%= t "Invisible" %>', jsonmap: 'invisible',width: 300, formatter: AppUtils.arrayToString},
                ];
    
    ResultsView = Backbone.View.extend({
        // tagName : 'div',

        initialize : function() {
            this.template = _.template($('#query-results-template').html());
        },
        
        render : function() {
            this.$el.html($(this.template()));
            $('#report-results-area').html(this.$el);
            
            this.grid = $('.result-table').jqGrid({
                colModel : this.options.colModel,
                cmTemplate: {sortable:false, cellattr: function (rowId, tv, rawObject, cm, rdata) { return 'style="white-space: pre-wrap;"' }},
                datatype: 'jsonstring',
                datastr: this.options.resultsCollection.toJSON(),
                jsonReader :{
                    repeatitems : false,
                    page: "currpage",
                    records: "totalrecords",
                    root : "rowdata",
                    total: "totalpages",
                    id : "id",
                },
                viewrecords: true,
                height: "auto",
                autowidth: true,
                ignoreCase: true,
                gridview: true,
                pager : '#result-pager',
                caption: this.options.caption,
                rowList:[10,20,50,100],
                rowNum:50
                });

            var grid = this.grid;
            jQuery(window).bind('resize', function() {
                var width = grid.parents('.ui-jqgrid').parent().width();
                grid.setGridWidth(width);
                grid.parents('.ui-jqgrid').css("width", width+2);
            }).trigger('resize');
            
            return this;
        }

    });
    
    var reportRegion = new Backbone.Marionette.Region({
        el: "#report-form-area"
    });
    var resultRegion = new Backbone.Marionette.Region({
        el: "#report-results-area"
    });

    var ReportView = Marionette.ItemView.extend({
        events: {
            "click .report-submit-button" : "submit",
            "click .report-csv-button" : "submitCSV"
        },
        
        initialize : function() {
            this.template = _.template($('#report-template').html());
        },
        
        render : function() {
            this.$el.html($(this.template()));
            
            this.form = new this.options.form({}).render();
            
            this.$el.find(".report-body").html(this.form.el);
        },
        
        submitCSV : function() {
            var data = this.form.getValue();
            
            $.download(this.options.endPoint + '.csv', data );
        },
        
        // TODO - we want XML and CSV exports as well
        submit : function() {
            // Gather the data from the form and send it to the back end
            var data = this.form.getValue();
            var colModel = this.options.colModel;
            var caption = this.options.caption;

            resultSet = new ResultSet();
            resultSet.fetch({
                url : this.options.endPoint + '.json',
                type : 'POST',
                data : data,
                error : function(model, response) {
                  alertMessage("ERROR: unable to get the result from the server");
                },
                success : function(model) {
                        resultsView = new ResultsView({
                                    colModel : colModel,
                                    resultsCollection : model,
                                    caption : caption
                        });
                        resultsView.render();
                        
                        // resultRegion.show(new ResultsView({
                                    // colModel : colModel,
                                    // resultsCollection : model
                                // }));                                        
                }
            })
        }
    });
    
    var Workspace = Backbone.Router.extend({

        routes : {
            'panels_with_panelists' : 'panels_with_panelists',
            'panelists_with_panels' : 'panelists_with_panels',
            'scheduling_conflicts' : 'scheduling_conflicts',
            'tags_by_context' : 'tags_by_context',
            'people_by_tags' : 'people_by_tags'
        },
        
        panels_with_panelists : function() {
            reportRegion.close();
            resultRegion.close();
            reportRegion.show(new ReportView({
                form        : PanelsWithPanelistsForm,
                endPoint    : '/planner_reports/panels_with_panelists',
                colModel    : PanelsWithPanelistsColModel,
                caption     : '<%= t "Panels with Panelists" %>'
            }));
        },
        
        panelists_with_panels : function() {
            reportRegion.close();
            resultRegion.close();
            reportRegion.show(new ReportView({
                form        : PanelistsWithPanelsForm,
                endPoint    : '/planner_reports/panelists_with_panels',
                colModel    : PanelistsWithPanelsColModel,
                caption     : '<%= t "Panelists with Panels" %>'
            }));
        },
        
        scheduling_conflicts : function() {
            reportRegion.close();
            resultRegion.close();
            
            conflictLayout = new AppUtils.ConflictLayout({
                template : "#conflict-layout-template"
            });

            // Render the conflicts for this day
            conflicts = new AppUtils.Conflicts();
            conflicts.fetch({
                url : "/program_planner/getConflicts.json", // TODO - fix domain and sub-site
                success : function(obj) {
                    AppUtils.createConflictCollectionView(obj.get('schedule'), "#schedule-conflict-view-template",conflictLayout.scheduleRegion);
                    AppUtils.createConflictCollectionView(obj.get('room'), "#room-conflict-view-template",conflictLayout.roomRegion);
                    AppUtils.createConflictCollectionView(obj.get('excluded_item'), "#excluded-item-conflict-view-template",conflictLayout.excludedItemRegion);
                    AppUtils.createConflictCollectionView(obj.get('excluded_time'), "#excluded-time-conflict-view-template",conflictLayout.excludedTimeRegion);
                    AppUtils.createConflictCollectionView(obj.get('availability'), "#availability-conflict-view-template",conflictLayout.availabilityRegion);
                    AppUtils.createConflictCollectionView(obj.get('back_to_back'), "#back-to-back-conflict-view-template",conflictLayout.backToBackRegion);
                } 
            });
            resultRegion.show(conflictLayout);
        },
        
        tags_by_context : function() {
            reportRegion.close();
            resultRegion.close();
            reportRegion.show(new ReportView({
                form        : TagsByContextForm,
                endPoint    : '/planner_reports/admin_tags_by_context',
                colModel    : TagsByContextColModel,
                caption     : '<%= t "Tags by Context" %>'
            }));
        },
        
        people_by_tags : function() {
            reportRegion.close();
            resultRegion.close();
            reportRegion.show(new ReportView({
                form        : PeopleByTagForm,
                endPoint    : '/planner_reports/people_by_tag',
                colModel    : PeopleByTagColModel,
                caption     : '<%= t "People by Tag" %>'
            }));
        }
        
    });
    
    /*
     * 
     */
    return {
        init : function(options) {
            new Workspace();
            Backbone.history.start();
        }
    }
    
})(Backbone);

/*
 * 
 */
jQuery(document).ready(function() {
    ReportApp.addInitializer(ReportApp.ReportManagement.init);
    ReportApp.start({});
});

</script>
