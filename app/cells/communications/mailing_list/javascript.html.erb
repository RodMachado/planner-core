<script type="text/javascript">

CommunicationsApp = new Backbone.Marionette.Application();

CommunicationsApp.CommunicationsList = (function(Backbone){
    
    var currentMailingId = null;
    
    Mailing = Backbone.DeepModel.extend({
        urlRoot : '/communications/mailing',
        schema : {
            mailing_number          : { type : 'Number', title : '<%= t "Mailing Number" %>' },
            mail_template_id        : { type : 'Select', title : '<%= t "Mail Template" %>',
                                            options : <%= [].concat(MailTemplate.find(:all).collect {|s| {'val' => s.id, 'label' => s.title} }).to_json.html_safe %>
                                        },
            scheduled               : { type : 'Checkbox', title : '<%= t "Scheduled" %>' },
            testrun                 : { type : 'Checkbox', title : '<%= t "Test Run" %>' }
        }
    });
    
    MailingCollection = Backbone.Collection.extend({
        model : Mailing
    });
    
    MailingLayout = Backbone.Marionette.Layout.extend({
        template: "#mailing-list-layout-template",
        
        regions : {
            mailingControlRegion: "#mailing-control-div",
            mailingRegion: "#mailing-region-div",
        },
    });
    
    MailingListControlView = Marionette.ItemView.extend({
        el : '#list-control-view',
        template : '#list-control-view-template',
        
        events : {
            "click .add-people-button" : "addPeople",
            "click .remove-people-button" : "removePeople"
        },
        
        addPeople : function(ev) {
            // do nowt if there is no current mailing list
            var selectedIds = jQuery('#participants').jqGrid('getGridParam','selarrrow'); // get ids of the selected people
            var args = { people : selectedIds,
                         mailing : currentMailingId 
                       };
            
            jQuery.ajax( "/communications/mailing/addPeople.json",
                     {
                         type : 'PUT',
                         data : args,
                         error : function() {
                            alertMessage('<%= t "unable to add people to the mailing" %>');
                         },
                         success : function() {
                            // add them to the mailing list
                            jQuery('#participants').jqGrid('resetSelection');
                            // refresh the lists
                            jQuery('#participants').trigger("reloadGrid");
                            jQuery('#mailing-participants').trigger("reloadGrid");
                         }
                     });

        },

        removePeople : function(ev) {
            // do nowt if there is no current mailing list
            var selectedIds = jQuery('#mailing-participants').jqGrid('getGridParam','selarrrow'); // get ids of the selected people
            var args = { people : selectedIds,
                         mailing : currentMailingId 
                       };
            jQuery.ajax( "/communications/mailing/removePeople.json",
                     {
                         type : 'PUT',
                         data : args,
                         error : function() {
                            alertMessage('<%= t "unable to remove people from the mailing" %>');
                         },
                         success : function() {
                            // add them to the mailing list
                            jQuery('#mailing-participants').jqGrid('resetSelection');
                            // refresh the lists
                            jQuery('#participants').trigger("reloadGrid");
                            jQuery('#mailing-participants').trigger("reloadGrid");
                         }
                     });
        }
    });
    
    var tabLists = [];
    
    function clearDetails() {
        _.invoke(tabLists, 'reset' );
    };
    
    function showMailings() {
        mailingLayout = new MailingLayout();
        mailingLayout.render();
        $('#mailing-region-view').html(mailingLayout.el);
        
        TabUtils.createTabControl({
            template                : "#mailing-control-template",
            modelType               : Mailing,
            view_refresh_event      : "mailing:refresh",
            modal_create_title      : '<%= t "Create Mailing" %>',
            region                  : mailingLayout.mailingControlRegion,
        });
        
        tabLists.push( AppUtils.createCollectionView({
            url                     : "/communications/mailing.json", // TODO
            collectionType          : MailingCollection,
            region                  : mailingLayout.mailingRegion,
            template                : "#mailing-template",
            collection_attributes   : { "class" : "table table-striped table-condensed" },
            collection_tagName      : 'table',
            tagName                 : 'tr',
            view_refresh_event      : "mailing:refresh",
            // drillDownFn             : drillDownMailing,
            selectFn                : selectMailing,
            readTemplate            : '#mailing-data-template',
            itemArea                : "#mailing-edit-area"
        }) );
    };
    
    function selectMailing(id) {
        currentMailingId = id;
        jQuery("#mailing-participants").participantTable('mailingQuery',{
            mailingId : id
        });
        jQuery("#mailing-participants").participantTable('render');
        jQuery("#participants").participantTable('mailingQuery',{
            mailingId : id,
            op : 'not'
        });
        jQuery("#participants").participantTable('render');
    };
    
    /*
     * 
     */
    return {
        init : function() {
            showMailings();
            var ctlView = new MailingListControlView();
            ctlView.render();
        },
        
        clearDetails : function() {
        },
        
        // selectMailing : function(id) {
        // }
    }

})(Backbone);

/*
 * 
 */
jQuery(document).ready(function() {
    CommunicationsApp.start();
    CommunicationsApp.CommunicationsList.init();
});

</script>
