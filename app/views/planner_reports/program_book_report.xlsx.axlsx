xlsx_package.use_shared_strings = true
wb = xlsx_package.workbook
wb.add_worksheet(name: "Program") do |sheet|

    sheet.add_row [
        'Datetime',
        'Day',
        'Time',
        'Duration',
        'Room',
        'Venue',
        'Tracks',
        'Format',
        'Title',
        'Description',
        'Participants',
        'Short Title',
        'Publication Reference Number',
        'Medium Image URL',
        'Large Image URL'
    ]

    @times.each do |time|
        sheet.add_row [
            time.start + Time.zone.utc_offset.seconds, # fix for the timezone, since Excel does not understand timezones
            time.start.strftime('%A'),
            time.start.strftime('%H:%M'),
            time.programme_items[0].duration,
            time.rooms[0].name,
            time.rooms[0].venue.name,
            time.programme_items[0].tag_list_on(:PrimaryArea).join(","),
            (time.programme_items[0].format ? time.programme_items[0].format.name : ""),
            time.programme_items[0].title,
            ((@short_desc && !time.programme_items[0].short_precis.blank?) ? time.programme_items[0].short_precis : time.programme_items[0].precis),
            time.programme_items[0].programme_item_assignments.find_all {|x| x.role == PersonItemRole['Participant'] || x.role == PersonItemRole['Moderator']}.collect{|p| 
                p.person.getFullPublicationName + (p.role == PersonItemRole['Moderator'] ? ' (M)' : '') }.join(","),
            time.programme_items[0].short_title,
            time.programme_items[0].pub_reference_number,
            time.programme_items[0].external_images.use('mediumcard')[0] ? time.programme_items[0].external_images.use('mediumcard')[0].picture.url : '',
            time.programme_items[0].external_images.use('largecard')[0] ? time.programme_items[0].external_images.use('largecard')[0].picture.url : ''
        ]
    end
    
end
